<!DOCTYPE html >
<html>
<head>
<meta name="Generator" content="tpshop" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>购物流程-{$tpshop_config['shop_info_store_title']}</title>
<meta http-equiv="keywords" content="{$tpshop_config['shop_info_store_keyword']}" />
<meta name="description" content="{$tpshop_config['shop_info_store_desc']}" />
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
<link rel="stylesheet" href="__STATIC__/css/public.css">
<link rel="stylesheet" href="__STATIC__/css/flow.css">
<link rel="stylesheet" href="__STATIC__/css/style_jm.css">
<script type="text/javascript" src="__STATIC__/js/jquery.js"></script>
<script src="__PUBLIC__/js/global.js"></script>
<script src="__PUBLIC__/js/mobile_common.js"></script>
</head>
<style>
.order-buy .address::after{
  border-right: 1px solid #989696;
  border-top: 1px solid #989696;
}
.order-buy .address{
  background:white;
  color:black;
  margin-bottom: 5pt

}
.order-buy .address::before{
  content:none
}
.order-buy .address{
  padding-left: 12px
}
.order-buy .address .address-info .address-phone {
    text-align: left;
}
.goods-list-title{
  border: 0
}
.order-buy .order-info .order-list-info .list-info{
  padding: 0;
  border: 0;
  margin-bottom: 10pt
}
.flow_youhui_no{
  border: 0
}
.BonusButton{
  width: 15px;
  border-radius: 20pt;
  height: 15px;
  background: #989696
}
.txt1{
  border: 0
}
.jmbag{
  color:black
}
.order_total_ul{
  padding-bottom: 0
}
.order-buy .order-info .subtotal{
  padding: 0;
  border: 0
}
.checkgoods .tdother2{
  background: white
}
.subbox_other tr td{
  background: white;
  font-size: 12pt;
    line-height: 2;
}
label{
  font-weight: bold
}
.order-buy .order-info{
  border-radius: 5pt
}
.order-buy .address{
  border-radius: 5pt;
  margin-top: 50px;
}
.header{
  position:fixed
}
</style>
<body style="background: rgb(235, 236, 237);position:relative;">
<div class="tab_nav">
  <div class="header">
    <div class="h-left"> <a class="sb-back" href="javascript:history.back(-1)" title="返回"></a> </div>
    <div class="h-mid" style="font-width:bold"> 确认订单 </div>
  </div>
</div>
<div class="screen-wrap fullscreen login"> 
<form name="cart2_form" id="cart2_form" method="post">
    <section class="content" style="min-height: 294px;">
    <div class="wrap">
    <div class="active" style="min-height: 294px;">
    <div class="content-buy">
    <div class="wrap order-buy">
    <a href="{:U('User/address_list',array('source'=>'cart2'))}">
	    <section class="address">
	      <div class="address-info" style=" font-weight: bold;" >
	        <p class="address-name" style="color:black">{$address.consignee}</p>
	        <p class="address-phone" style="color:black">{$address.mobile}</p>
	      </div>
	      <div class="address-details" style="background: #E85B4D;
        border-radius: 20pt;
        width: 15%;    margin-right: 5pt;
        display: -webkit-inline-box;
        text-align: -webkit-center;color:white;
       ">默认</div><small style="color: #666666;">{$address.address}</small>
          <input type="hidden" value="{$address.address_id}" name="address_id" />
	    </section>
    </a>
    <section class="order " id="order4">
      <div  class="order-info" style="margin-top:0;">
      <!--
        	<h4 class="seller-name" > <img src="__STATIC__/images/flow/dingdan.png" width="28"> 
        		订单详情 <a class="modify" href="{:U('Cart/cart')}">修改</a></h4>
      -->          
      </div>
      <section class="order-info" style=" margin-top:0px;">
        <div class="order-list">          
          <ul class="order-list-info">
<!--商品列表-->
<foreach name="storeList" item="v">
          
            <div class="goods-list-title" > {$v[store_name]}</div>
           <foreach name="cartList" item="v2"  key="k">
	           <if condition="($v2[selected] eq '1') and ($v2[store_id] eq $v[store_id])">
                    <li class="item" >
                      <div class="itemPay list-price-nums" id="itemPay17">
                        <!-- <p class="price">￥{$v2.member_goods_price}元</p> -->
                        <p class="nums">x{$v2.goods_num}</p>
                      </div>
                      <div class="itemInfo list-info" id="itemInfo12">
                        <div class="list-img"> <a href="{:U('Mobile/Goods/goodsInfo',array('id'=>$v2[goods_id]))}">
                            <if condition="$v2[original_img] neq ''">
                                <img src="{:C('qiniu.url')}{$v2[original_img]} "
                                     height="70">
                                <else/>
                                <img src="{:C('yuming.url')}public/images/icon_goods_thumb_empty_300.png"
                                     alt="">
                            </if>

                        </a> </div>
                        <div class="list-cont">
                          <h5 class="goods-title" style="-webkit-line-clamp: 1;    width: 180pt;font-weight: bold;">{$v2.goods_name} </h5>
                          <p class="godds-specification">{$v2.spec_key_name}</p>
                           <p class="price" style="color:#E85B4D;font-size: 13pt; font-weight: bold;"><small style="font-size: 9pt;">￥</small>{$v2.member_goods_price}</p>
                        </div>
                      </div>
                    </li>
                </if>  
            </foreach>
			<li class="flow_youhui_no" style="display: block">
              <div class="checkout_other">
                <div class="jmbag" style="font-weight: bold;" href="javascript:void(0);" onClick="showCheckoutOther(this);"><span  class="right_arrow_flow"></span >使用优惠券</div>
                <table class="subbox_other sub_bonus" width="100%">
                  <tr>
                    <td  colspan="2">
                    <input type="radio" class="radio vam ma-ri-10" name="couponTypeSelect[{$v[store_id]}]" checked value="1"  onClick="ajax_order_price();javascript:document.getElementById('Bonus_span_0').style.display='none';" />
                     <select id="coupon_id" name="coupon_id[{$v[store_id]}]" class="vam ou-no" onChange="ajax_order_price();">
                          <option value="0">选择优惠券</option>
                         <foreach name="couponList" item="v3">
                            <if condition="($v3[store_id] eq $v[store_id])">
                       		  <option value="{$v3['id']}">{$v3['name']}</option>
                            </if>
                         </foreach>
                     </select>
                    </td>
                    </tr>
                    <!-- <tr>
                    <td>
                    &nbsp;或 &nbsp;
                    <input type="radio" class="radio vam ma-ri-10" name="couponTypeSelect[{$v[store_id]}]"  value="2"  onClick="ajax_order_price();javascript:document.getElementById('Bonus_span_0').style.display='block';" />
                    <a href="javascript:void(0);"  class="a_other1_h" id="Bonus_a_0">直接输入优惠券</a>
                    </td>
                    </tr> -->
                    <tr>
                    <td>
                      <label id="Bonus_span_0" style="display:none;">
                        <input name="couponCode[{$v[store_id]}]" id="bonus_sn_0" type="text"   value="" placeholder="输入优惠券"  class="txt1" style="width:144px;"/>
                        <input name="validate_bonus" type="button" value="使用" onClick="ajax_order_price();" class="BonusButton" />
                      </label>
                    </td>
                    </tr>
                </table>
              </div>
            </li>
            <li class="flow_youhui_no" style="border-bottom: 1pt solid #efebeb;">
              <label>
                 给卖家留言：
                         <input style="border:0" type="text" placeholder="给卖家留言" name="user_note[{$v[store_id]}]" style="vertical-align:middle" class="txt1">            
                  </label>
             </li>      
			<li class="flow_youhui_no">
       			<label>
       			   选择物流： 
                         <select onChange="ajax_order_price();" class="vam ou-no" name="shipping_code[{$v[store_id]}]">                                                                                                     
                            <foreach name="shippingList" item="v4"  key="k4">
                                 <if condition="$v4['store_id'] eq $v['store_id']">
                                     <option value="{$v4.shipping_code}">{$v4.name}</option>
                                 </if>
                            </foreach>
                         </select>                   
                 </label>
            </li>  
		      <!-- <div style="width:100%;height:5pt;background:#989696"></div>      -->
</foreach>            
            
            <li class="flow_youhui_no">
       			<label>
       			   使用余额：
                   <input id="user_money" name="user_money"  type="text"   placeholder="输入余额" onpaste="this.value=this.value.replace(/[^\d.]/g,'')" onkeyup="this.value=/^\d+\.?\d{0,2}$/.test(this.value) ? this.value : ''" class="txt1" style="width:100px;"/>
                   <input name="validate_bonus" type="button" value="✔" onClick="ajax_order_price();" class="BonusButton" style=" display: -webkit-inline-box; line-height: 1
                   "/>
                 	<p style="text-align: -webkit-right;">您的可用余额&nbsp;￥<em id="ye" style="color:#E85B4D; ;">{$user['user_money']}</em></p>
                 </label>
            </li>
            <li style="display: none">
                <label>
                    <input id="tid" name="tid" type="text" value="{$tid}">
                </label>
            </li>
            
            <li class="flow_youhui_no" style="display: none">
       			<label>
       			   使用积分：
                   <input id="pay_points" name="pay_points" type="text"   placeholder="输入积分"  onpaste="this.value=this.value.replace(/[^\d]/g,'')" onKeyUp="this.value=this.value.replace(/[^\d]/g,'')" class="txt1" style="width:100px;"/>
                   <input name="validate_bonus" type="button" value="使用" onClick="ajax_order_price();" class="BonusButton" />
                 	您的可用积分<em>{$user['pay_points']}</em>
                 </label>
            </li>
          </ul>
        </div>
      </section>
    </section>
      
   <section class="order-info">
    <div class="order-list">
      <div class="content ptop0">
        <div class="panel panel-default info-box">
          <div class="orderInfo " >
            <h4 class="seller-name">  其他选项 </h4>
          </div>
          <table border=0 cellpadding=0 cellspacing=0 width="100%" class="checkgoods">
            <tr>
              <td colspan=4 class="tdother2" style="border-top:none;"><div class="checkout_other" >
                  <div class="jmbag" href="javascript:void(0);" onClick="showCheckoutOther(this);"><span class="right_arrow_flow"></span>开发票和缺货处理</div>
                  <div class="subbox_other" width="100%">
                    <table id='normal_invoice_tbody' width="100%">
                      <tr>
                        <td align=right style="vertical-align:top" width="84">发票抬头：</td>
                        <td colspan="2">
                          <input class="txt1" style='vertical-align:middle' type="text" name="invoice_title" placeholder="XXX单位 或 XX个人" />
                        </td>
                      </tr>                      
                    </table>                     
                  </div>
                </div>
                </td>
            </tr>                                   
          </table>
        	<div style="height:10px; line-height:10px; clear:both;"></div>
        </div></div></div>
        </section>
        <section class="order-info">
        <div class="order-list">
          <div class="content ptop0">
            <div class="panel panel-default info-box">
              <div class="con-ct fo-con">
                <ul class="ct-list order_total_ul" id="ECS_ORDERTOTAL" >
                  <!--<li class="order_total_li" >-->
                  		<!--*该订单完成后，您将获得 <span class="price">相应的</span> 积分<br/>-->
                  <!--</li>-->
                  <li>
                   <div class="subtotal" style=" font-weight: bold;
                   ">
                      <span class="total-text" style="display: -webkit-inline-box;
                      float: left;">商品总额：</span><em class="price">￥{$total_price.total_fee}</em><br/>
                      <span class="total-text" style="display: -webkit-inline-box;
                      float: left;">配送费用：</span>+&nbsp;¥&nbsp;<em class="price" id="postFee">{$total_price.shipping_price}</em><br/>
                      <!--<span class="total-text">使用优惠券：</span>-&nbsp;¥&nbsp;<em class="price" id="couponFee">0</em>元<br/>-->
                      <!--<span class="total-text">使用积分：</span>-&nbsp;¥&nbsp;<em class="price" id="pointsFee">0</em>元<br/>-->
                      <span class="total-text" style="display: -webkit-inline-box;
                      float: left;">使用余额：</span>-&nbsp;¥&nbsp;<em class="price" id="balance">0</em><br/>
                      <span class="total-text" style="display: -webkit-inline-box;
                      float: left;">优惠活动：</span>-&nbsp;¥&nbsp;<em class="price" id="order_prom_amount">0</em><br/> 
                      <div style=" border-top: 1pt solid #cec4c4;;
                      line-height: 3;">
                      <small style="float: left;
                      line-height: 7;
                      color:#E85B4D;
                      font-weight:bold">￥</small>                     
                      <strong style="font-size:18pt;float: left;" class="price_total" id="payables">0</strong>
                      <div class="panel panel-default info-box">
                        <div class="pay-btn">
                          <input style="float: right;
                          display: -webkit-box;
                          background: #E85B4D;
                          border-radius:20pt;
                          width:40%" onClick="submit_order();" type="button" class="sub-btn btnRadius" value="提交订单"/>
                        </div>
                      </div>
                    </div>
                   </div>
                  </li>
                </ul>
              </div>
              <!-- <div class="panel panel-default info-box">
                <div class="pay-btn">
                  <input style="float: right;
                  display: -webkit-box;
                  background: #E85B4D;
                  border-radius:20pt;
                  width:40%" onClick="submit_order();" type="button" class="sub-btn btnRadius" value="提交订单"/>
                </div>
              </div> -->
            </div>
            </div>
            </div>
         </section>
         </div>
        </div>
      </div>
    </div>
 	</section>
  </form>
  </div>
<section class="f_mask" style="display: none;"></section>
<include file="public/footer"/>
<script type="text/javascript">

// $("#user_money").change(function(e){
//   var ab=$("#user_money")
//   if(ab[0].value>0){
//     $(".BonusButton").css("background","#e31939");
//         e.stopPropagation();
//   }
// })

  $(".BonusButton").click(function(e){
    var ye=$("#ye")
    var ab=$("#user_money")
    
    if(ab[0].value>0 && ab[0].value<=ye[0].innerHTML){
      $(this).css("background","#e31939");
        e.stopPropagation();
      }else{$(this).css("background","#989696");
        e.stopPropagation();}
        // $(this).css("background","#e31939");
        // e.stopPropagation();
       
        // console.log(ab[0].value)
  })


  // $(".BonusButton").click(function(e){
  //       $(this).css("background","#e31939");
  //       e.stopPropagation();
  //       console.log($("#user_money").value)
  // })
 



    $(document).ready(function(){
        ajax_order_price(); // 计算订单价钱
    });

// 获取订单价格
function ajax_order_price()
{
    $.ajax({
        type : "POST",
        url:'/index.php?m=Mobile&c=Cart&a=cart3&act=order_price&t='+Math.random(),
        data : $('#cart2_form').serialize(),
        dataType: "json",
        success: function(data){

            if(data.status != 1)
            {
                alert(data.msg);
                // 登录超时
                if(data.status == -100)
                    location.href ="{:U('Mobile/User/login')}";

                return false;
            }
            // console.log(data);
            if(data.result.couponFee == null){
                $("#couponFee").text(0);// 优惠券
            }else{
                $("#couponFee").text(data.result.couponFee);// 优惠券
            }
            $("#postFee").text(data.result.postFee); // 物流费
            $("#balance").text(data.result.balance);// 余额
            $("#pointsFee").text(data.result.pointsFee);// 积分支付
            $("#payables").text(data.result.payables);// 应付
			$("#order_prom_amount").text(data.result.order_prom_amount);// 订单 优惠活动 									
        }
    });
}

// 提交订单
ajax_return_status = 1; // 标识ajax 请求是否已经回来 可以进行下一次请求
function submit_order()
{
	if(ajax_return_status == 0)
	    return false;
		
	ajax_return_status = 0;
		
    $.ajax({
        type : "POST",
        url:"{:U('Mobile/Cart/cart3')}",//+tab,
        data : $('#cart2_form').serialize()+"&act=submit_order",// 你的formid
        dataType: "json",
        success: function(data){

            if(data.status != '1')
            {
                alert(data.msg); //执行有误
                // 登录超时
                if(data.status == -100)
                    location.href ="{:U('Mobile/User/login')}";

				ajax_return_status = 1; // 上一次ajax 已经返回, 可以进行下一次 ajax请求

                return false;
            }
            // console.log(data);
            $("#postFee").text(data.result.postFee); // 物流费
            if(data.result.couponFee == null){
                $("#couponFee").text(0);// 优惠券
            }else{
                $("#couponFee").text(data.result.couponFee);// 优惠券
            }
            $("#balance").text(data.result.balance);// 余额
            $("#pointsFee").text(data.result.pointsFee);// 积分支付
            $("#payables").text(data.result.payables);// 应付
			$("#order_prom_amount").text(data.result.order_prom_amount);// 订单 优惠活动 									
            alert('订单提交成功，跳转支付页面!');
		    location.href = "/index.php?m=Mobile&c=Cart&a=cart4&tid={$tid}&master_order_sn="+data.result; // 跳转到结算页
        }
    });
}
</script>
</body>
</html>